# Safe User-level Access to Privileged CPU Features
## abstract
Dune是一个系统，它为应用程序提供直接但安全的访问硬件特性，例如环保护、页表和标记TLB，同时保留进程的现有操作系统接口。Dune利用现代处理器中的虚拟化硬件提供进程而不是机器抽象。它由一个小的内核模块和一个用户级库组成，帮助应用程序管理特权硬件特性。我们为64位x86 Linux实现了Dune，并使用Dune实现了三个用户级应用程序，这些应用程序可以从访问特权硬件中受益：用于不受信任代码的沙盒、特权分离设施和垃圾收集器。使用Dune大大简化了这些应用程序的实现，并提供了显着的性能优势。

## Intro
许多应用程序都有望从访问“仅内核(能使用)”的硬件功能中受益。例如，Azul Systems通过使用分页硬件在垃圾收集中实现了显著的加速。另一个例子是，虽然可以在用户程序中实现进程迁移，但通过页错误和系统调用可以大大改善其性能。在某些情况下，甚至可能需要完全替换内核以满足特定应用程序的需求。例如，IBOS通过将浏览器抽象移至最低的操作系统层来提高浏览器安全性。 

这些系统需要对内核进行更改，因为出于安全和隔离原因，用户空间对硬件访问受到限制。不幸的是，在实践中修改内核并不理想，因为内核更改可能相当具有侵入性，并且如果执行不正确，可能会影响整个系统的稳定性。此外，如果多个应用程序需要内核更改，则无法保证这些更改会组合起来。也就是说，如果多个应用程序都需要对内核进行修改，这些修改可能会相互冲突，导致系统不稳定。

另一种策略是将应用程序捆绑到具有专用内核的虚拟机映像中。许多现代CPU都包含虚拟化硬件，使得客户操作系统可以安全有效地访问内核硬件功能。此外，虚拟机提供与进程类似的故障隔离功能，即有错误或恶意行为不应该导致整个物理机器崩溃。也就是说，虚拟机可以将应用程序隔离在自己的虚拟环境中，从而保护主机系统免受应用程序的影响。虚拟机还可以提供其他优点，例如在不同的操作系统之间运行应用程序，或者在同一台物理机器上运行多个应用程序，而不会相互干扰。

不幸的是，虚拟机与主机操作系统的集成性较差。进程希望从其父进程继承文件描述符，生成其他进程，与其父进程和子进程共享文件系统和设备，并使用IPC服务，例如Unix域套接字。将进程移动到虚拟机中，例如为了加速垃圾收集，可能会破坏许多假设，并且可能根本不值得麻烦。此外，为应用程序特定的虚拟机生成内核并不是一项小任务。生产一个内核（例如Linux）是复杂且难以修改的。而且，实现具有简单虚拟内存层的专用内核也具有挑战性。除了虚拟内存外，还必须支持文件系统、网络堆栈、设备驱动程序和引导程序。

本文介绍了一种应用程序使用内核硬件功能的新方法：使用虚拟化硬件提供进程，而不是机器抽象。我们在名为Dune的系统中为64位Intel CPU上的Linux实现了这种方法。Dune提供了一个可加载的内核模块，可以与未修改的Linux内核一起使用。该模块允许进程进入“Dune模式”，这是一种不可逆转的转换，在其中，通过虚拟化硬件，启用对特权硬件功能的安全快速访问，包括特权模式、虚拟内存寄存器、页表以及中断、异常和系统调用向量。我们提供了一个用户级库libDune，以便使用这些功能。

对于符合其范式的应用程序，Dune相对于虚拟机提供了几个优势。首先，Dune进程是一个普通的Linux进程，唯一的区别是它使用VMCALL指令来调用系统调用。这意味着Dune进程可以直接访问主机系统的资源，而无需创建完整的虚拟机环境。这意味着Dune进程可以完全访问系统的其他部分，并且是系统的一个组成部分，Dune的应用也很容易开发(就像开发用户程序一样，而非在内核编程)。由于Dune内核模块并不试图提供机器抽象，因此该模块可以更简单和更快速。特别是，虚拟化硬件可以配置为避免保存和恢复虚拟机所需的多个硬件状态。

通过Dune，我们做出了以下贡献：
• 我们提出了一种设计，利用硬件辅助虚拟化，安全有效地向用户程序公开特权硬件功能，同时保留标准操作系统抽象。
• 我们详细评估了三个硬件功能，并展示了它们如何使用户程序受益：异常、分页和特权模式。
• 我们通过实现和评估三个用例（沙箱、特权分离和垃圾回收）展示了Dune的端到端实用性。


## 虚拟化和硬件

在这一部分，我们回顾了虚拟化的硬件支持，并讨论了Dune能够公开哪些特权硬件功能。在整篇论文中，我们以x86 CPU和Intel VT-x来描述Dune。然而，这并不是我们设计的基础，而在第7节中，我们扩大了讨论范围，包括未来可能支持的其他体系结构。

### Intel VT-x 扩展
为了提高虚拟化性能并简化VMM实现，英特尔开发了VT-x，这是x86 ISA的虚拟化扩展。AMD也提供了一个类似的扩展，但具有不同的硬件接口，称为SVM.

将硬件适配为支持虚拟化的最简单方法是引入一种机制，用于捕获每个访问特权状态的指令，以便由VMM执行仿真。而VT-x采用了一种更复杂的方法，受IBM的解释执行架构启发，尽可能多的指令，包括大多数访问特权状态的指令，直接在硬件中执行，无需VMM干预。这种方法的动机是为了提高性能，因为陷阱可能是性能开销的重要来源。

VT-x采用了一种设计，其中CPU被分为两个操作模式：VMX根模式和VMX非根模式。VMX根模式通常用于运行VMM，并且不改变CPU的行为，除了启用用于管理VT-x的新指令。而VMX非根模式则限制CPU的行为，旨在运行虚拟化的客户操作系统。在VMX非根模式下，CPU的行为受到限制，以防止客户操作系统访问特权状态或执行敏感操作。

VMX模式之间的转换由硬件管理。当VMM执行VMLAUNCH或VMRESUME指令时，硬件执行VM进入操作，将CPU置于VMX非根模式并执行客户操作系统。然后，当VMM需要执行操作时，硬件执行VM退出操作，将CPU置回VMX根模式并跳转到VMM的入口点。硬件在这两种类型的转换过程中自动保存和恢复大部分的体系结构状态。这是通过使用内存中的数据结构（称为VM控制结构）中的缓冲区来实现的。

除了存储体系结构状态外，VMCS还包含大量的配置参数，允许VMM控制执行并指定哪种类型的事件应该生成VM退出。这使得VMM在确定向客户公开哪些硬件方面具有相当大的灵活性。例如，VMM可以配置VMCS，使得HLT指令导致VM退出，或者允许客户操作系统停止CPU。然而，一些硬件接口，如中断描述符表（IDT）和特权模式，在VMX非根模式下会隐式暴露，并在访问时不会生成VM退出。此外，客户操作系统可以通过使用VMCALL指令手动请求VM退出。

虚拟内存可能是VMM安全公开的最困难的硬件特性。一个简单的解决方案是配置VMCS，使得客户操作系统可以访问页表根寄存器%CR3。然而，这会完全信任客户操作系统，因为它可以配置页表以访问任何物理内存地址，包括属于VMM的内存。幸运的是，VT-x包括一个专用的硬件机制，称为扩展页表（EPT），可以强制执行对直接访问虚拟内存的客户操作系统的内存隔离。它通过应用第二个底层地址转换层来实现，只能由VMM进行配置。AMD的SVM包括类似于EPT的机制，称为嵌套页表（NPT）。

### 支持的硬件特性
Dune利用VT-x为用户程序提供对x86保护硬件的完全访问权限。这包括三个特权硬件功能：异常处理、虚拟内存和特权模式。Dune还公开了分段机制，但我们不再进一步讨论，因为在现代x86 CPU上，分段机制主要是一种遗留机制。

在各种用例中，如仿真、调试和性能跟踪，高效支持异常处理非常重要。通常，向用户程序报告异常需要特权模式转换和上调机制（例如，信号）。Dune可以减少异常处理的开销，因为它使用VT-x在硬件中直接传递异常。然而，这并不允许Dune进程垄断CPU，因为定时器中断和其他针对内核的异常仍会导致VM退出。最终结果是，软件开销被消除，异常处理性能仅由硬件效率决定。例如，与Linux中的SIGSEGV相比，Dune提高了传递页面故障异常的速度超过4倍。还加速了几种其他类型的异常，包括断点、浮点溢出和下溢、除以零和无效操作码。

用户程序也可以从快速灵活的虚拟内存访问中受益。使用案例包括检查点、垃圾回收（在本文中进行了评估）、数据压缩分页和分布式共享内存。Dune通过直接向用户程序公开页表项来改进虚拟内存访问，允许它们使用简单的内存引用来控制地址转换、访问权限、全局位和修改/访问位。相比之下，即使是最高效的操作系统接口也会通过需要系统调用来执行这些操作而增加额外的延迟。让应用程序编写自己的页表不会影响安全性，因为底层的EPT只公开正常的进程地址空间，即使没有Dune也同样可以访问。

Dune还赋予用户程序手动控制TLB失效的能力。因此，当应用程序允许时，可以批量执行页表更新。这在内核中支持要困难得多，因为当必须维护一般正确性时，推迟TLB失效是很困难的。此外Dune通过提供intel最近添加的上下文标识符特性的访问权而实现了暴露TLB标记。这允许单个用户程序在多个页表之间高效切换。总的来说，我们展示使用Dune在Appel和Li用户级虚拟内存基准测试中比Linux提高了7倍的速度。这个数字包括使用异常硬件来减少页面故障延迟。

Dune还公开了对特权模式的访问。在x86上，最重要的特权模式是ring 0（监管模式）和ring 3（用户模式），尽管ring 1和ring 2也是可用的。特权模式的两个激励使用案例是特权分离和不受信任代码的沙盒化，这两者在本文中进行了评估。Dune可以有效地支持特权模式，因为VMX非根模式维护其自己的特权环。因此，Dune允许在进程内硬件强制保护，就像内核保护自己免受用户进程的影响一样。页表中的监管位可用于控制内存隔离。此外，系统调用指令陷入到进程本身，而不是内核，这可用于系统调用拦截，并防止不受信任的代码直接访问内核。与Linux中的ptrace相比，我们展示了Dune可以以25倍的开销拦截系统调用。虽然Dune公开的硬件特性足以支持我们的激励使用案例，但是还有其他几种硬件特性，例如缓存控制、调试寄存器和对DMA设备的访问，也可以通过虚拟化硬件安全地公开。我们将这些留给未来的工作，并在第7节中讨论它们的潜力。

### 



















