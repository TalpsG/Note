# lec10 sorting & aggregate

主要讲了外部排序。
## top-k heap sort 
如果一个查询包含了`order by`和`limit`，则使用`top-k`的堆排序是很有效的，如果数据都在内存中则，堆排序对这种需求很好

## 外部归并
外部归并排序分为两个阶段
1. 排序
2. 合并

对于待排数据`kv`，`value`可以是整个`tuple`也可以是`rowid`之类的指针

大致思想如下：
如果内存可以存放三个页面，则每次读入两个页面到内存，然后排序借助空页面将读入的两个页面排序输出回磁盘，继续读入未排序的页面。一轮过后，数据变成了有序页面的块，每个块中有两个页面。然后读取两个块的第一个页面，继续排序。此轮完成获得四个有序页面的块，以此类推，完成排序。


如果要排序的条件上有聚簇索引，则可以使用聚簇索引,这样就不需要排序操作了(聚簇索引会导致磁盘的数据按索引顺序存储)

## 聚合操作
`dbms`为了高效的完成聚合操作，需要一种快速的方式来对数据进行分组。
1. 排序
2. 哈希

对排序后的数据，去重或分组会更快。

但是排序的开销很大，因此我们往往不会因为聚集操作而对数据进行排序。

哈希在某些情况下的效果也很好
1. 只需要去重的时候
2. 计算量比排序低的时候


### 外部哈希聚集
1. 划分：将数据划分到`bucket`中
2. `rehash`：再次哈希，为了去重或`group by`之后的聚集操作


在`rehash`阶段中，在`hashtable`中存储`(groupkey,runningval)`的二元组，每次对一个`tuple`进行`rehash`，查找该表的`groupkey`,能对上就要修改`runningval`，否则创建新的二元组。