# lec11
连表查询，即`join`
主要关注了`inner equal join`

我们称`sql`语句先出现的表为外表，或者左表.
为了优化`sql`语句，通常让小的表当外表。

在查询的处理中我们也要关注何时返回查询结果(早物化或者晚物化的问题).

早物化会提早去原表中查找数据，可以让之后的操作不需要再去表中查找数据了。
而晚物化则尽可能推迟去原表中查找数据的过程，对列存储很友好，因为不需要存取用不到的数据

## 连表算法
1. 嵌套循环
  - 原始的方法: 类似二重循环，对每条外表数据，遍历内表查找目标数据
  - 块循环：做了一定的优化，为了减少硬盘读取的速度，每次保存外表的一个块，然后同样对内表遍历。
  - 如果内存的空间大，可以保存多个外表的块，并行的去查询，这样磁盘io的时间会进一步减小。
  - 哈希嵌套，应用于带索引的内表中，对每条外表数据，按索引查找内表的数据。
2. 排序归并连接
  - 先排序，在归并
  - 两个排好序的表都有各自的指针，查找数据的过程会移动指针，对一般数据来说，只需要遍历这两张表的开销。但是对于数据全部相等的情况，会退化成原始的嵌套循环连接


对于排序归并连接的方法，适用于数据已经排好或要排序输出的情况下

## 哈希连接
对外表的key,即连接要求的属性的值构建哈希表，然后对内表使用哈希表。落到相同多个桶内再检查是否对应的属性值相同。

哈希表即使对`key`进行了哈希，还是要保存一个`kv`,因为要检查桶内的`key`是否相同,`value`可以存放`rowid`或者整个`tuple`，这里涉及早物化晚物化的问题


在对内表进行`hash`时可以加一个布隆过滤器，布隆过滤器可以加快对内表的哈希过程。

布隆过滤器说不在哈希表内，一定不在。但是说在可能会存在假阳性的可能。


如果外表很大，导致外表的哈希表无法整个存放到内存中时，频繁的`buffer pool`的换入换出很影响效率。

日本东京大学发明了优雅哈希连接的方法:
1. 使用同一个哈希函数对内外表都进行划分，划分到两个哈希表中
2. 对两个哈希表中对应的桶内进行嵌套循环查询

如果某一个桶很大就要对桶进行再次哈希，直到能放回内存。
